import { useEffect, useState } from "react";
import {
  Form, Input, DatePicker, InputNumber, Button,
  Card, message, Space, Select, AutoComplete
} from "antd";
import { useNavigate, useParams } from "react-router-dom";
import { ArrowLeftOutlined } from "@ant-design/icons";
import axios from "axios";
import dayjs from "dayjs";

const API = "http://localhost:8080/api/admin/flights";

const AdminFlightFormPage = () => {
  const [form] = Form.useForm();
  const navigate = useNavigate();
  const { flightId, depTime } = useParams();
  const [loading, setLoading] = useState(false);
  const isEdit = !!flightId && !!depTime;

  const [airlines, setAirlines] = useState([
    "ÎåÄÌïúÌï≠Í≥µ", "ÏïÑÏãúÏïÑÎÇòÌï≠Í≥µ", "Ï†úÏ£ºÌï≠Í≥µ", "ÏßÑÏóêÏñ¥", "ÏóêÏñ¥Î∂ÄÏÇ∞", "Ìã∞Ïõ®Ïù¥Ìï≠Í≥µ", "ÏóêÏñ¥ÏÑúÏö∏",
  ]);

  const [airports] = useState([
    { airportCode: "GMP", airportName: "ÍπÄÌè¨" },
    { airportCode: "CJU", airportName: "Ï†úÏ£º" },
    { airportCode: "PUS", airportName: "ÍπÄÌï¥(Î∂ÄÏÇ∞)" },
    { airportCode: "TAE", airportName: "ÎåÄÍµ¨" },
    { airportCode: "CJJ", airportName: "Ï≤≠Ï£º" },
    { airportCode: "KWJ", airportName: "Í¥ëÏ£º" },
    { airportCode: "MWX", airportName: "Î¨¥Ïïà" },
    { airportCode: "RSU", airportName: "Ïó¨Ïàò" },
    { airportCode: "USN", airportName: "Ïö∏ÏÇ∞" },
    { airportCode: "KUV", airportName: "Íµ∞ÏÇ∞" },
    { airportCode: "YNY", airportName: "ÏñëÏñë" },
    { airportCode: "HIN", airportName: "ÏÇ¨Ï≤ú" },
    { airportCode: "WJU", airportName: "ÏõêÏ£º" },
    { airportCode: "JDG", airportName: "Ï†ïÏÑù(ÌõàÎ†®)" },
  ]);

  /** ‚úÖ Îã®Í±¥ Ìï≠Í≥µÌé∏ Ï°∞Ìöå */
  useEffect(() => {
    const fetchFlight = async () => {
      if (!isEdit) return;
      setLoading(true);
      try {
        const token = localStorage.getItem("accessToken");
        const encodedTime = encodeURIComponent(depTime);
        const res = await axios.get(`${API}/${flightId}/${encodedTime}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = res.data;
        form.setFieldsValue({
          flightId: data.flightId,
          airlineNm: data.airlineNm,
          depAirportNm: data.depAirportNm,
          arrAirportNm: data.arrAirportNm,
          depTime: dayjs(data.depTime),
          arrTime: dayjs(data.arrTime),
          economyCharge: data.economyCharge,
          prestigeCharge: data.prestigeCharge,
        });
      } catch (err) {
        console.error(err);
        message.error("Ìï≠Í≥µÌé∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
      } finally {
        setLoading(false);
      }
    };
    fetchFlight();
  }, [isEdit, flightId, depTime, form]);

  /** ‚úÖ Îì±Î°ù / ÏàòÏ†ï */
  const onFinish = async (values) => {
    setLoading(true);
    try {
      const token = localStorage.getItem("accessToken");

      if (values.depAirportNm === values.arrAirportNm) {
        message.warning("Ï∂úÎ∞úÍ≥µÌï≠Í≥º ÎèÑÏ∞©Í≥µÌï≠Ïù¥ ÎèôÏùºÌï©ÎãàÎã§.");
        setLoading(false);
        return;
      }
      if (values.depTime.isAfter(values.arrTime)) {
        message.warning("ÎèÑÏ∞©ÏãúÍ∞ÑÏùÄ Ï∂úÎ∞úÏãúÍ∞ÑÎ≥¥Îã§ Îä¶Ïñ¥Ïïº Ìï©ÎãàÎã§.");
        setLoading(false);
        return;
      }

      const payload = {
        ...values,
        depTime: values.depTime.toISOString(),
        arrTime: values.arrTime.toISOString(),
      };

      if (isEdit) {
        const encodedTime = encodeURIComponent(depTime);
        await axios.put(`${API}/${flightId}/${encodedTime}`, payload, {
          headers: { Authorization: `Bearer ${token}` },
        });
        message.success("Ìï≠Í≥µÌé∏Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.");
      } else {
        await axios.post(API, payload, {
          headers: { Authorization: `Bearer ${token}` },
        });
        message.success("Ìï≠Í≥µÌé∏Ïù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
      }

      setTimeout(() => navigate("/adm/flight/list"), 800);
    } catch (err) {
      console.error(err);
      message.error("Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    } finally {
      setLoading(false);
    }
  };

  /** ‚úÖ Í≥µÌï≠ ÏûêÎèôÏôÑÏÑ± Îç∞Ïù¥ÌÑ∞ */
  const airportOptions = airports.map((a) => ({
    value: a.airportName,
    label: `${a.airportName} (${a.airportCode})`,
    code: a.airportCode,
  }));

  const handleAirportSelect = (value, option, field) => {
    form.setFieldValue(field, value);
    console.log(`[ÏÑ†ÌÉùÎê®] ${field}:`, option.code);
  };

  return (
    <div style={{ background: "#f8f9fc", minHeight: "100vh", padding: "50px 0" }}>
      <Card
        title={
          <Space>
            <Button icon={<ArrowLeftOutlined />} onClick={() => navigate(-1)} style={{ borderRadius: 8 }}>
              Îí§Î°úÍ∞ÄÍ∏∞
            </Button>
            <span>{isEdit ? "‚úàÔ∏è Ìï≠Í≥µÌé∏ ÏàòÏ†ï" : "üÜï Ìï≠Í≥µÌé∏ Îì±Î°ù"}</span>
          </Space>
        }
        bordered={false}
        style={{
          maxWidth: 800,
          margin: "0 auto",
          borderRadius: 16,
          boxShadow: "0 8px 20px rgba(0,0,0,0.06)",
          background: "#fff",
        }}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={onFinish}
          autoComplete="off"
          initialValues={{ economyCharge: 0, prestigeCharge: 0 }}
        >
          {/* ‚úàÔ∏è Ìï≠Í≥µÌé∏Î™Ö */}
          <Form.Item label="Ìï≠Í≥µÌé∏Î™Ö (Ïòà: LJ305)" name="flightId" rules={[{ required: true, message: "Ìï≠Í≥µÌé∏Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî." }]}>
            <Input placeholder="Ìï≠Í≥µÌé∏Î™Ö ÏûÖÎ†•" disabled={isEdit} />
          </Form.Item>

          {/* Ìï≠Í≥µÏÇ¨ */}
          <Form.Item label="Ìï≠Í≥µÏÇ¨Î™Ö" name="airlineNm" rules={[{ required: true, message: "Ìï≠Í≥µÏÇ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî." }]}>
            <Select
              showSearch
              placeholder="Ìï≠Í≥µÏÇ¨ ÏÑ†ÌÉù ÎòêÎäî ÏßÅÏ†ë ÏûÖÎ†•"
              optionFilterProp="children"
              dropdownRender={(menu) => (
                <>
                  {menu}
                  <div style={{ padding: 8 }}>
                    <Input
                      placeholder="ÏßÅÏ†ë Ï∂îÍ∞Ä"
                      onPressEnter={(e) => {
                        const newAirline = e.target.value.trim();
                        if (newAirline && !airlines.includes(newAirline)) {
                          setAirlines([...airlines, newAirline]);
                          form.setFieldValue("airlineNm", newAirline);
                          message.success(`Ìï≠Í≥µÏÇ¨ '${newAirline}' Ï∂îÍ∞ÄÎê®`);
                        }
                        e.target.value = "";
                      }}
                    />
                  </div>
                </>
              )}
            >
              {airlines.map((a) => (
                <Select.Option key={a} value={a}>
                  {a}
                </Select.Option>
              ))}
            </Select>
          </Form.Item>

          {/* Í≥µÌï≠ */}
          <Space size="large" style={{ display: "flex" }}>
            <Form.Item label="Ï∂úÎ∞úÍ≥µÌï≠" name="depAirportNm" rules={[{ required: true }]} style={{ flex: 1 }}>
              <AutoComplete
                options={airportOptions}
                placeholder="Ï∂úÎ∞úÍ≥µÌï≠ ÏûÖÎ†• (Ïòà: ÍπÄÌè¨)"
                onSelect={(value, option) => handleAirportSelect(value, option, "depAirportNm")}
                filterOption={(input, option) => option.label.toLowerCase().includes(input.toLowerCase())}
              />
            </Form.Item>
            <Form.Item label="ÎèÑÏ∞©Í≥µÌï≠" name="arrAirportNm" rules={[{ required: true }]} style={{ flex: 1 }}>
              <AutoComplete
                options={airportOptions}
                placeholder="ÎèÑÏ∞©Í≥µÌï≠ ÏûÖÎ†• (Ïòà: Ï†úÏ£º)"
                onSelect={(value, option) => handleAirportSelect(value, option, "arrAirportNm")}
                filterOption={(input, option) => option.label.toLowerCase().includes(input.toLowerCase())}
              />
            </Form.Item>
          </Space>

          {/* ÏãúÍ∞Ñ */}
          <Space size="large" style={{ display: "flex" }}>
            <Form.Item label="Ï∂úÎ∞úÏãúÍ∞Ñ" name="depTime" rules={[{ required: true }]} style={{ flex: 1 }}>
              <DatePicker showTime format="YYYY-MM-DD HH:mm" style={{ width: "100%" }} />
            </Form.Item>
            <Form.Item label="ÎèÑÏ∞©ÏãúÍ∞Ñ" name="arrTime" rules={[{ required: true }]} style={{ flex: 1 }}>
              <DatePicker showTime format="YYYY-MM-DD HH:mm" style={{ width: "100%" }} />
            </Form.Item>
          </Space>

          {/* ÏöîÍ∏à */}
          <Space size="large" style={{ display: "flex" }}>
            <Form.Item label="ÏùºÎ∞òÏÑù ÏöîÍ∏à" name="economyCharge" rules={[{ required: true }]} style={{ flex: 1 }}>
              <InputNumber
                min={0}
                style={{ width: "100%" }}
                formatter={(v) => `${v}`.replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
                parser={(v) => v.replace(/,/g, "")}
                placeholder="Ïòà: 45000"
              />
            </Form.Item>
            <Form.Item label="ÎπÑÏ¶àÎãàÏä§ ÏöîÍ∏à" name="prestigeCharge" rules={[{ required: true }]} style={{ flex: 1 }}>
              <InputNumber
                min={0}
                style={{ width: "100%" }}
                formatter={(v) => `${v}`.replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
                parser={(v) => v.replace(/,/g, "")}
                placeholder="Ïòà: 120000"
              />
            </Form.Item>
          </Space>

          {/* Î≤ÑÌäº */}
          <Form.Item style={{ marginTop: 32 }}>
            <Space style={{ width: "100%", justifyContent: "flex-end" }}>
              <Button onClick={() => navigate("/adm/flight/list")}>Ï∑®ÏÜå</Button>
              <Button
                type="primary"
                htmlType="submit"
                loading={loading}
                style={{
                  background: "linear-gradient(90deg,#2563eb,#1d4ed8)",
                  border: "none",
                  boxShadow: "0 4px 10px rgba(37,99,235,0.3)",
                }}
              >
                {isEdit ? "ÏàòÏ†ïÌïòÍ∏∞" : "Îì±Î°ùÌïòÍ∏∞"}
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Card>
    </div>
  );
};

export default AdminFlightFormPage;
